<script>
  document.getElementById('y').textContent = new Date().getFullYear();

  // --- Gate protection (client-side) ---
  (function(){
    const gate = document.getElementById('memberGate');
    const form = document.getElementById('memberGateForm');
    const pass = document.getElementById('memberPass');
    const err = document.getElementById('gateError');

    const openGate = () => {
      gate.classList.add('is-open');
      gate.setAttribute('aria-hidden','false');
      err.textContent = '';
      pass.value = '';
      setTimeout(() => pass.focus(), 50);
    };
    const closeGate = () => {
      gate.classList.remove('is-open');
      gate.setAttribute('aria-hidden','true');
    };

    const isAuthed = () => {
      try{ return sessionStorage.getItem('fs_member') === '1'; }catch(_){ return false; }
    };

    gate.querySelectorAll('[data-gate-close]').forEach(el => el.addEventListener('click', () => {
      if(!isAuthed()) window.location.href = 'index.html';
      else closeGate();
    }));

    window.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && gate.classList.contains('is-open')){
        if(!isAuthed()) window.location.href = 'index.html';
        else closeGate();
      }
    });

    function attachMultiTap(el, tapsRequired, onDone){
      if(!el) return;
      let taps = 0;
      let timer = null;
      let lastTouchLike = 0;

      const reset = () => {
        taps = 0;
        if(timer){ clearTimeout(timer); timer = null; }
      };

      const bump = (src) => {
        const now = Date.now();
        if(src === 'click' && (now - lastTouchLike) < 450) return;
        if(src !== 'click') lastTouchLike = now;

        taps += 1;
        if(timer) clearTimeout(timer);
        timer = setTimeout(reset, 1100);

        if(taps >= tapsRequired){
          reset();
          onDone && onDone();
        }
      };

      if(window.PointerEvent){
        el.addEventListener('pointerup', (e) => {
          if(e.isPrimary === false) return;
          bump('pointer');
        }, { passive:true });
      } else {
        el.addEventListener('touchend', () => bump('touch'), { passive:true });
        el.addEventListener('mouseup',  () => bump('mouse'),  { passive:true });
      }

      el.addEventListener('click', () => bump('click'), { passive:true });
    }

    const headerLogo = document.querySelector('.brand__logo') || document.querySelector('.brand');
    attachMultiTap(headerLogo, 6, openGate);

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const val = (pass.value || '').trim();
      if(val === 'DarkSide'){
        try{ sessionStorage.setItem('fs_member', '1'); }catch(_){ }
        closeGate();
        return;
      }
      err.textContent = 'Falsches Passwort. Versuch’s nochmal.';
      pass.focus();
      pass.select();
    });

    if(!isAuthed()) openGate();
  })();

  // --- Simple merch placeholders + cart -> mailto ---
  (function () {
    const PRODUCTS = [
      {
        id: 'tee',
        name: 'FlensSabers T-Shirt',
        meta: 'Black • Unisex • Größen: S–XXL',
        price: '22,00 €',
        images: ['images/shop/tee-front.png', 'images/shop/tee-back.png']
      },
      {
        id: 'hoodie',
        name: 'FlensSabers Kapuzen Hoodie',
        meta: 'Black • Premium • Größen: S–XXL',
        price: '28,00 €',
        images: ['images/shop/khoodie-front.png', 'images/shop/khoodie-back.png']
      },
      {
        id: 'pullover',
        name: 'FlensSabers Pullover',
        meta: 'Black • Premium • Größen: S–XXL',
        price: '26,00 €',
        images: ['images/shop/pl-front.png', 'images/shop/pl-back.png']
      },
      {
        id: 'polo',
        name: 'FlensSabers Poloshirt',
        meta: 'Black • Unisex • Größen: S–XXL',
        price: '24,00 €',
        images: ['images/shop/polo-front.png', 'images/shop/polo-back.png']
      },
      {
        id: 'jacket',
        name: 'FlensSabers Jacke',
        meta: 'Black • Premium • Größen: S–XXL',
        price: '29,00 €',
        images: ['images/shop/jk-front.png', 'images/shop/jk-back.png']
      }
    ];

    const grid = document.getElementById('shopGrid');
    const cartEmpty = document.getElementById('cartEmpty');
    const cartList = document.getElementById('cartList');
    const sendBtn = document.getElementById('sendOrder');
    const clearBtn = document.getElementById('clearCart');

    const cart = new Map(); // id -> {p, qty}

    const renderGrid = () => {
      grid.innerHTML = PRODUCTS.map(p => {
        const imgs = (p.images || []).slice(0, 2).map(src => `
          <img class="product__img" src="${src}" alt="${p.name}" loading="lazy" />
        `).join('');

        return `
          <article class="product" data-id="${p.id}">
            <div class="product__imgs">${imgs}</div>
            <div class="product__body">
              <h3 class="product__name">${p.name}</h3>
              <p class="product__meta">${p.meta}</p>
              <div class="product__row">
                <span class="pill">Preis: ${p.price}</span>
                <button class="btn btn--primary" type="button" data-add="${p.id}">+ In den Warenkorb</button>
              </div>
            </div>
          </article>
        `;
      }).join('');
    };

    const renderCart = () => {
      const items = [...cart.values()];
      cartEmpty.style.display = items.length ? 'none' : 'block';
      cartList.innerHTML = items.map(({p, qty}) => `
        <li class="cart__item">
          <div>
            <strong>${p.name}</strong>
            <small>${p.price} • ${p.meta}</small>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn btn--ghost" type="button" data-dec="${p.id}" aria-label="minus">−</button>
            <strong>${qty}</strong>
            <button class="btn btn--ghost" type="button" data-inc="${p.id}" aria-label="plus">+</button>
          </div>
        </li>
      `).join('');
    };

    const add = (id) => {
      const p = PRODUCTS.find(x => x.id === id);
      if(!p) return;
      const entry = cart.get(id);
      cart.set(id, { p, qty: (entry?.qty || 0) + 1 });
      renderCart();
    };
    const inc = (id) => add(id);
    const dec = (id) => {
      const entry = cart.get(id);
      if(!entry) return;
      const next = entry.qty - 1;
      if(next <= 0) cart.delete(id);
      else cart.set(id, { p: entry.p, qty: next });
      renderCart();
    };

    const buildMail = () => {
      const items = [...cart.values()];
      if(!items.length) return null;
      const lines = [
        'Moin FlensSabers,',
        '',
        'ich möchte folgenden Merch bestellen (Mitgliederbereich):',
        ''
      ];
      items.forEach(({p, qty}) => {
        lines.push(`- ${qty}x ${p.name} | ${p.price}`);
        lines.push(`  Details: ${p.meta}`);
      });
      lines.push(
        '',
        'Bitte Rückfrage zu Größen/Farben/Abholung/Bezahlung stellen.',
        '',
        'Name:',
        'Telefon:',
        'Größen/Farben:',
        '',
        'Danke & Grüße'
      );
      return { subject: 'FlensSabers Merch Bestellung', body: lines.join('\n') };
    };

    renderGrid();
    renderCart();

    grid.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-add]');
      if(!btn) return;
      add(btn.getAttribute('data-add'));
    });

    cartList.addEventListener('click', (e) => {
      const incBtn = e.target.closest('[data-inc]');
      const decBtn = e.target.closest('[data-dec]');
      if(incBtn) return inc(incBtn.getAttribute('data-inc'));
      if(decBtn) return dec(decBtn.getAttribute('data-dec'));
    });

    clearBtn.addEventListener('click', () => {
      cart.clear();
      renderCart();
    });

    sendBtn.addEventListener('click', () => {
      const mail = buildMail();
      if(!mail){
        alert('Warenkorb ist leer.');
        return;
      }
      window.location.href =
        `mailto:mail@flenssabers.de?subject=${encodeURIComponent(mail.subject)}&body=${encodeURIComponent(mail.body)}`;
    });
  })();
</script>
